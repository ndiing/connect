module.exports=["USE [master];","GO","","-- ALTER DATABASE [otomax] SET SINGLE_USER WITH ROLLBACK IMMEDIATE;","-- GO","-- DROP DATABASE IF EXISTS [otomax];","-- GO","-- CREATE DATABASE [otomax];","-- GO","","ALTER AUTHORIZATION ON DATABASE::otomax TO sa;","GO","","IF(SELECT is_broker_enabled FROM sys.databases WHERE name = 'otomax')<>1","BEGIN","    ALTER DATABASE [otomax] SET ENABLE_BROKER WITH ROLLBACK IMMEDIATE;","END","GO","","USE [otomax];","GO","","ALTER DATABASE otomax","SET COMPATIBILITY_LEVEL = 150","","IF NOT EXISTS(SELECT 1 FROM sys.service_message_types WHERE name = '//otomax/message')","BEGIN","    CREATE MESSAGE TYPE [//otomax/message];","END","GO","","IF NOT EXISTS(SELECT 1 FROM sys.service_contracts WHERE name = '//otomax/contract')","BEGIN","    CREATE CONTRACT [//otomax/contract] ([//otomax/message] SENT BY ANY);","END","GO","","IF NOT EXISTS(SELECT 1 FROM sys.service_queues WHERE name = 'otomax_queue')","BEGIN","    CREATE QUEUE otomax_queue;","END","GO","","IF NOT EXISTS(SELECT 1 FROM sys.services WHERE name = 'otomax_service')","BEGIN","    CREATE SERVICE [otomax_service] ON QUEUE otomax_queue ([//otomax/contract]);","END","GO","","USE otomax;","GO","","CREATE OR ALTER PROCEDURE usp_service_broker_send ","    @message VARCHAR(MAX)","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","","    DECLARE @dialog_handle UNIQUEIDENTIFIER;","","    BEGIN DIALOG @dialog_handle","    FROM SERVICE [otomax_service] ","    TO SERVICE 'otomax_service'","    ON CONTRACT [//otomax/contract] ","    WITH ENCRYPTION=OFF; ","","    SEND ON CONVERSATION @dialog_handle","    MESSAGE TYPE [//otomax/message] (@message);","END","GO","","CREATE OR ALTER PROCEDURE usp_service_broker_receive","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","","    WAITFOR (  ","        RECEIVE TOP (1)","            message_body","        FROM [otomax_queue]  ","    ), TIMEOUT 1000","END","GO","","USE otomax","GO","","-- fn","","USE otomax","GO","","-- usp","","CREATE OR ALTER PROCEDURE usp_get_transaksi","    @kode int","    ,@tgl_awal varchar(30)","    ,@tgl_akhir varchar(30)","    ,@kode_produk varchar(20)","    ,@tujuan varchar(50)","    ,@kode_reseller varchar(20)","    ,@status tinyint","    ,@page int","    ,@limit int","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","","    SET @page = ISNULL(@page, 1)","    SET @limit = ISNULL(@limit, 20)","","    SELECT * FROM transaksi","    WHERE kode_reseller = @kode_reseller","    AND (ISNULL(@tgl_awal,'')<>'' AND tgl_entri >= @tgl_awal OR ISNULL(@tgl_awal,'')='')","    AND (ISNULL(@tgl_akhir,'')<>'' AND tgl_entri <= @tgl_akhir OR ISNULL(@tgl_akhir,'')='')","    AND (ISNULL(@kode_produk,'')<>'' AND kode_produk = @kode_produk OR ISNULL(@kode_produk,'')='')","    AND (ISNULL(@tujuan,'')<>'' AND tujuan = @tujuan OR ISNULL(@tujuan,'')='')","    AND (ISNULL(@status,'')<>'' AND status = @status OR ISNULL(@status,'')='')","    AND (ISNULL(@kode,'')<>'' AND kode = @kode OR ISNULL(@kode,'')='')","    ORDER BY kode DESC","    OFFSET (@page-1)*@limit ROWS","    FETCH NEXT @limit ROWS ONLY","END","GO","","CREATE OR ALTER PROCEDURE usp_get_inbox","    @kode int","    ,@tgl_awal varchar(30)","    ,@tgl_akhir varchar(30)","    ,@pengirim varchar(255)","    ,@tipe_pengirim char(1)","    ,@pesan varchar(4000)","    ,@status tinyint","    ,@kode_reseller varchar(20)","    ,@page int","    ,@limit int","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","","    SET @page = ISNULL(@page, 1)","    SET @limit = ISNULL(@limit, 20)","","    SELECT * FROM inbox","    WHERE kode_reseller = @kode_reseller","    AND (ISNULL(@tgl_awal,'')<>'' AND tgl_entri >= @tgl_awal OR ISNULL(@tgl_awal,'')='')","    AND (ISNULL(@tgl_akhir,'')<>'' AND tgl_entri <= @tgl_akhir OR ISNULL(@tgl_akhir,'')='')","    AND (ISNULL(@pengirim,'')<>'' AND pengirim = @pengirim OR ISNULL(@pengirim,'')='')","    AND (ISNULL(@tipe_pengirim,'')<>'' AND tipe_pengirim = @tipe_pengirim OR ISNULL(@tipe_pengirim,'')='')","    AND (ISNULL(@pesan,'')<>'' AND pesan = '%'+@pesan+'%' OR ISNULL(@pesan,'')='')","    AND (ISNULL(@kode,'')<>'' AND kode = @kode OR ISNULL(@kode,'')='')","    AND (ISNULL(@status,'')<>'' AND status = @status OR ISNULL(@status,'')='')","    ORDER BY kode DESC","    OFFSET (@page-1)*@limit ROWS","    FETCH NEXT @limit ROWS ONLY","END","GO","","CREATE OR ALTER PROCEDURE usp_get_outbox","    @kode int","    ,@tgl_awal varchar(30)","    ,@tgl_akhir varchar(30)","    ,@penerima varchar(255)","    ,@tipe_penerima char(1)","    ,@pesan varchar(4000)","    ,@status tinyint","    ,@kode_reseller varchar(20)","    ,@page int","    ,@limit int","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","","    SET @page = ISNULL(@page, 1)","    SET @limit = ISNULL(@limit, 20)","","    SELECT * FROM outbox","    WHERE kode_reseller = @kode_reseller","    AND (ISNULL(@tgl_awal,'')<>'' AND tgl_entri >= @tgl_awal OR ISNULL(@tgl_awal,'')='')","    AND (ISNULL(@tgl_akhir,'')<>'' AND tgl_entri <= @tgl_akhir OR ISNULL(@tgl_akhir,'')='')","    AND (ISNULL(@penerima,'')<>'' AND penerima = @penerima OR ISNULL(@penerima,'')='')","    AND (ISNULL(@tipe_penerima,'')<>'' AND tipe_penerima = @tipe_penerima OR ISNULL(@tipe_penerima,'')='')","    AND (ISNULL(@pesan,'')<>'' AND pesan = '%'+@pesan+'%' OR ISNULL(@pesan,'')='')","    AND (ISNULL(@kode,'')<>'' AND kode = @kode OR ISNULL(@kode,'')='')","    AND (ISNULL(@status,'')<>'' AND status = @status OR ISNULL(@status,'')='')","    ORDER BY kode DESC","    OFFSET (@page-1)*@limit ROWS","    FETCH NEXT @limit ROWS ONLY","END","GO","","CREATE OR ALTER PROCEDURE usp_get_mutasi","    @kode int","    ,@kode_reseller varchar(20)","    ,@tanggal_awal varchar(30)","    ,@tanggal_akhir varchar(30)","    ,@jumlah money","    ,@keterangan varchar(255)","    ,@jenis char(1)","    ,@page INT","    ,@limit INT","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","","    SET @page = ISNULL(@page, 1)","    SET @limit = ISNULL(@limit, 20)","","    SELECT * FROM mutasi","    WHERE kode_reseller = @kode_reseller","    AND (ISNULL(@tanggal_awal,'')<>'' AND tanggal >= @tanggal_awal OR ISNULL(@tanggal_awal,'')='')","    AND (ISNULL(@tanggal_akhir,'')<>'' AND tanggal <= @tanggal_akhir OR ISNULL(@tanggal_akhir,'')='')","    AND (ISNULL(@keterangan,'')<>'' AND keterangan LIKE '%'+@keterangan+'%' OR ISNULL(@keterangan,'')='')","    AND (ISNULL(@jumlah,'')<>'' AND jumlah = @jumlah OR ISNULL(@jumlah,'')='')","    AND (ISNULL(@jenis,'')<>'' AND jenis = @jenis OR ISNULL(@jenis,'')='')","    AND (ISNULL(@kode,'')<>'' AND kode = @kode OR ISNULL(@kode,'')='')","    ORDER BY kode DESC","    OFFSET (@page-1)*@limit ROWS","    FETCH NEXT @limit ROWS ONLY","END","GO","","CREATE OR ALTER PROCEDURE usp_get_operator","    @kode varchar(10)","    ,@nama varchar(30)","    ,@page INT","    ,@limit INT","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","","    SET @page = ISNULL(@page, 1)","    SET @limit = ISNULL(@limit, 20)","","    SELECT * FROM operator","    WHERE 1=1","    AND (ISNULL(@kode,'')<>'' AND kode LIKE @kode OR ISNULL(@kode,'')='')","    AND (ISNULL(@nama,'')<>'' AND nama LIKE '%'+@nama+'%' OR ISNULL(@nama,'')='')","    ORDER BY kode","    OFFSET (@page-1)*@limit ROWS","    FETCH NEXT @limit ROWS ONLY","END","GO","","CREATE OR ALTER PROCEDURE usp_get_produk","    -- DECLARE ","    @kode_reseller varchar(20) = 'OX0004'","    ,@kode varchar(10)","    ,@nama varchar(50)","    ,@kode_operator varchar(10)","    ,@nominal smallint","    ,@page int","    ,@limit int","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","","","    DECLARE ","    @kode_upline VARCHAR(20)","    ,@kode_level VARCHAR(10)","","    SET @page = ISNULL(@page, 1)","    SET @limit = ISNULL(@limit, 20)","","    SELECT ","        @kode_level = kode_level,","        @kode_upline = kode_upline","    FROM reseller WHERE kode = @kode_reseller","","    DECLARE @reseller TABLE (","        kode varchar(20)","        ,markup smallmoney","        ,kode_upline varchar(20)","    )","","    DECLARE @level TABLE (","        kode varchar(20)","        ,selisih_harga smallmoney","        ,kode_upline varchar(20)","    )","","    ;WITH cte_reseller AS (","        SELECT kode,markup,kode_upline, 0 AS i FROM reseller WHERE kode = @kode_reseller","        UNION ALL","        SELECT r.kode,r.markup,r.kode_upline, i+1 AS i FROM reseller r","        JOIN cte_reseller c ON c.kode_upline = r.kode","    )","    INSERT INTO @reseller","    SELECT kode,ISNULL(markup, 0) AS markup,kode_upline FROM cte_reseller ","    ORDER BY i DESC","","    ;WITH cte_level AS (","        SELECT kode,selisih_harga,kode_upline, 0 AS i FROM level WHERE kode = @kode_level","        UNION ALL","        SELECT l.kode,l.selisih_harga,l.kode_upline, i+1 AS i FROM level l","        JOIN cte_level c ON c.kode_upline = l.kode","    )","    INSERT INTO @level","    SELECT kode,ISNULL(selisih_harga, 0) AS selisih_harga,kode_upline FROM cte_level ","    ORDER BY i DESC","","    SELECT * FROM @reseller","    SELECT * FROM @level","","    SELECT * FROM produk_level","    WHERE kode_level IN (SELECT kode FROM @level)","","    SELECT * FROM markup_produk","    WHERE kode_reseller IN (SELECT kode FROM @reseller)","    OR kode_reseller IN (SELECT kode_upline+'.*' FROM @reseller)","    ORDER BY (CASE WHEN kode_reseller NOT LIKE '%.*' THEN kode_reseller END) DESC","","    SELECT * FROM produk","    WHERE 1=1","    AND (ISNULL(@kode,'')<>'' AND kode LIKE @kode OR ISNULL(@kode,'')='')","    AND (ISNULL(@nama,'')<>'' AND nama LIKE @nama OR ISNULL(@nama,'')='')","    AND (ISNULL(@kode_operator,'')<>'' AND kode_operator LIKE @kode_operator OR ISNULL(@kode_operator,'')='')","    AND (ISNULL(@nominal,'')<>'' AND nominal LIKE @nominal OR ISNULL(@nominal,'')='')","    ORDER BY kode","    OFFSET (@page-1)*@limit ROWS","    FETCH NEXT @limit ROWS ONLY","END","GO","","CREATE OR ALTER PROCEDURE usp_get_level","    -- DECLARE ","    @kode_reseller VARCHAR(20) = 'OX0001'","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","","    DECLARE @kode_level VARCHAR(10)","","    SELECT @kode_level=kode_level FROM reseller WHERE kode = @kode_reseller","    SELECT * FROM level WHERE kode = @kode_level","END","GO","","CREATE OR ALTER PROCEDURE usp_get_reseller","    -- DECLARE ","    @kode_reseller VARCHAR(20) = 'OX0001'","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","","    SELECT * FROM reseller WHERE kode = @kode_reseller","END","GO","","CREATE OR ALTER PROCEDURE usp_get_pengirim","    -- DECLARE ","    @kode_reseller VARCHAR(20) = 'OX0001'","    ,@pengirim VARCHAR(255)","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","","    SELECT * FROM pengirim ","    WHERE kode_reseller = @kode_reseller","    AND (ISNULL(@pengirim,'')<>'' AND pengirim = @pengirim OR ISNULL(@pengirim,'')='')","END","GO","","CREATE OR ALTER PROCEDURE usp_get_reseller_pengirim","    -- DECLARE ","    @pengirim VARCHAR(MAX)","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","","    SELECT ","        r.kode AS kode_reseller","        ,r.pin","        ,p.pengirim","    FROM pengirim p","    JOIN reseller r ON r.kode = p.kode_reseller ","    WHERE p.pengirim IN (SELECT value FROM OPENJSON(@pengirim))","END","GO","","CREATE OR ALTER PROCEDURE usp_get_parameter","    -- DECLARE","    @grup varchar(30)","    ,@nama varchar(50)","    -- ,@nilai varchar(255)","    -- ,@keterangan varchar(255)","    -- ,@tgl_data datetime","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","","    SELECT * FROM parameter","    WHERE (ISNULL(@grup,'')<>'' AND grup = @grup OR ISNULL(@grup,'')='')","    AND (ISNULL(@nama,'')<>'' AND nama = @nama OR ISNULL(@nama,'')='')","END","GO","","CREATE OR ALTER PROCEDURE usp_post_inbox","    -- DECLARE","    -- @kode int","    @tgl_entri datetime","    ,@penerima varchar(255)","    ,@pengirim varchar(255)","    ,@tipe_pengirim char(1)","    ,@pesan varchar(4000)","    ,@status tinyint","    ,@kode_terminal int","    ,@tgl_status datetime","    ,@kode_reseller varchar(20)","    -- ,@kode_transaksi int","    -- ,@is_jawaban tinyint","    -- ,@service_center varchar(100)","    -- ,@is_cs tinyint","    -- ,@kode_jawaban_cs int","    -- ,@hash varchar(30)","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","","    DECLARE @inbox TABLE (","        kode int","        ,tgl_entri datetime","        ,penerima varchar(255)","        ,pengirim varchar(255)","        ,tipe_pengirim char(1)","        ,pesan varchar(4000)","        ,status tinyint","        ,kode_terminal int","        ,tgl_status datetime","        ,kode_reseller varchar(20)","        ,kode_transaksi int","        ,is_jawaban tinyint","        ,service_center varchar(100)","        ,is_cs tinyint","        ,kode_jawaban_cs int","        ,hash varchar(30)","    )","","    SET @tgl_entri = ISNULL(@tgl_entri, GETDATE())","    SET @status = ISNULL(@status, 0)","    SET @tgl_status = ISNULL(@tgl_status, GETDATE())","","    INSERT INTO inbox (tgl_entri,penerima,pengirim,tipe_pengirim,pesan,status,kode_terminal,tgl_status,kode_reseller)","    OUTPUT ","        INSERTED.kode","        ,INSERTED.tgl_entri","        ,INSERTED.penerima","        ,INSERTED.pengirim","        ,INSERTED.tipe_pengirim","        ,INSERTED.pesan","        ,INSERTED.status","        ,INSERTED.kode_terminal","        ,INSERTED.tgl_status","        ,INSERTED.kode_reseller","        ,INSERTED.kode_transaksi","        ,INSERTED.is_jawaban","        ,INSERTED.service_center","        ,INSERTED.is_cs","        ,INSERTED.kode_jawaban_cs","        ,INSERTED.hash","    INTO @inbox","    VALUES (@tgl_entri,@penerima,@pengirim,@tipe_pengirim,@pesan,@status,@kode_terminal,@tgl_status,@kode_reseller)","","    SELECT * FROM @inbox","END","GO","","CREATE OR ALTER PROCEDURE usp_patch_outbox_status","    -- DECLARE ","    @kode int ","    -- ,@tgl_entri datetime","    -- ,@penerima varchar(255)","    -- ,@tipe_penerima char(1)","    -- ,@pesan varchar(4000)","    ,@status tinyint","    ,@tgl_status datetime","    -- ,@kode_inbox int","    -- ,@kode_transaksi int","    -- ,@kode_reseller varchar(20)","    -- ,@bebas_biaya tinyint","    -- ,@is_perintah tinyint","    -- ,@kode_modul int","    -- ,@prioritas tinyint","    -- ,@modul_proses varchar(255)","    -- ,@pengirim varchar(255)","    -- ,@kode_terminal int","    -- ,@ctr_kirim tinyint","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","","    SET @status=ISNULL(@status,20)","    SET @tgl_status=ISNULL(@tgl_status,GETDATE())","","    UPDATE outbox SET","        status=@status","        ,tgl_status=@tgl_status","    WHERE kode=@kode","END","GO","","CREATE OR ALTER PROCEDURE usp_post_outbox","    -- DECLARE ","    -- @kode int","    @tgl_entri datetime","    ,@penerima varchar(255)","    ,@tipe_penerima char(1)","    ,@pesan varchar(4000)","    ,@status tinyint","    ,@tgl_status datetime","    ,@kode_inbox int","    -- ,@kode_transaksi int","    ,@kode_reseller varchar(20)","    -- ,@bebas_biaya tinyint","    -- ,@is_perintah tinyint","    -- ,@kode_modul int","    -- ,@prioritas tinyint","    -- ,@modul_proses varchar(255)","    ,@pengirim varchar(255)","    ,@kode_terminal int","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","    SET @tgl_entri = ISNULL(@tgl_entri, GETDATE())","    SET @status = ISNULL(@status, 0)","    SET @tgl_status = ISNULL(@tgl_status, GETDATE())","","    DECLARE @outbox TABLE (","        kode int","        ,tgl_entri datetime","        ,penerima varchar(255)","        ,tipe_penerima char(1)","        ,pesan varchar(4000)","        ,status tinyint","        ,tgl_status datetime","        ,kode_inbox int","        ,kode_transaksi int","        ,kode_reseller varchar(20)","        ,bebas_biaya tinyint","        ,is_perintah tinyint","        ,kode_modul int","        ,prioritas tinyint","        ,modul_proses varchar(255)","        ,pengirim varchar(255)","        ,kode_terminal int","    )","","    INSERT outbox (tgl_entri,penerima,tipe_penerima,pesan,status,tgl_status,kode_inbox,kode_reseller,pengirim,kode_terminal)","    OUTPUT","        INSERTED.kode","        ,INSERTED.tgl_entri","        ,INSERTED.penerima","        ,INSERTED.tipe_penerima","        ,INSERTED.pesan","        ,INSERTED.status","        ,INSERTED.tgl_status","        ,INSERTED.kode_inbox","        ,INSERTED.kode_transaksi","        ,INSERTED.kode_reseller","        ,INSERTED.bebas_biaya","        ,INSERTED.is_perintah","        ,INSERTED.kode_modul","        ,INSERTED.prioritas","        ,INSERTED.modul_proses","        ,INSERTED.pengirim","        ,INSERTED.kode_terminal","    INTO @outbox","    VALUES (@tgl_entri,@penerima,@tipe_penerima,@pesan,@status,@tgl_status,@kode_inbox,@kode_reseller,@pengirim,@kode_terminal)","","    SELECT * FROM @outbox","END","GO","","USE otomax","GO","","-- tr","","CREATE OR ALTER TRIGGER tr_inbox ","   ON inbox","   WITH ENCRYPTION","   AFTER INSERT,DELETE,UPDATE","AS ","BEGIN","\tSET NOCOUNT ON;","    DECLARE ","    @action VARCHAR(6) = (CASE","        WHEN EXISTS(SELECT 1 FROM INSERTED) AND EXISTS(SELECT 1 FROM DELETED) THEN 'UPDATE'","        WHEN EXISTS(SELECT 1 FROM INSERTED) THEN 'INSERT'","        WHEN EXISTS(SELECT 1 FROM DELETED) THEN 'DELETE'","    END)","    ,@message VARCHAR(MAX)","","    IF (@action = 'UPDATE' OR @action = 'INSERT' OR @action = 'DELETE')","    BEGIN","        SET @message = (SELECT 'inbox' AS event_name, * FROM INSERTED FOR JSON PATH, INCLUDE_NULL_VALUES)","        EXEC usp_service_broker_send @message","    END","    ELSE IF (@action = 'DELETE')","    BEGIN","        SET @message = (SELECT 'inbox' AS event_name, * FROM DELETED FOR JSON PATH, INCLUDE_NULL_VALUES)","        EXEC usp_service_broker_send @message","    END","END","GO","","CREATE OR ALTER TRIGGER tr_outbox ","   ON outbox","   WITH ENCRYPTION","   AFTER INSERT,DELETE,UPDATE","AS ","BEGIN","\tSET NOCOUNT ON;","    DECLARE ","    @action VARCHAR(6) = (CASE","        WHEN EXISTS(SELECT 1 FROM INSERTED) AND EXISTS(SELECT 1 FROM DELETED) THEN 'UPDATE'","        WHEN EXISTS(SELECT 1 FROM INSERTED) THEN 'INSERT'","        WHEN EXISTS(SELECT 1 FROM DELETED) THEN 'DELETE'","    END)","    ,@message VARCHAR(MAX)","","    IF (@action = 'UPDATE' OR @action = 'INSERT' OR @action = 'DELETE')","    BEGIN","        SET @message = (SELECT 'outbox' AS event_name, * FROM INSERTED FOR JSON PATH, INCLUDE_NULL_VALUES)","        EXEC usp_service_broker_send @message","    END","    ELSE IF (@action = 'DELETE')","    BEGIN","        SET @message = (SELECT 'outbox' AS event_name, * FROM DELETED FOR JSON PATH, INCLUDE_NULL_VALUES)","        EXEC usp_service_broker_send @message","    END","END","GO","USE otomax","GO","","-- fn","","CREATE OR ALTER FUNCTION dbo.fn_json_operator ","(","\t@json VARCHAR(MAX)",")","RETURNS ","@table TABLE (","\tkode varchar(10)","\t,nama varchar(30)","\t,prefix_tujuan varchar(4000)","\t,gangguan tinyint","\t,kosong tinyint","\t,regex_tujuan varchar(255)","\t,kode_hlr varchar(30)","\t,panjang_maks tinyint","\t,panjang_min tinyint","\t,prioritas tinyint","\t,format_sukses varchar(255)","\t,kode_level varchar(255)","\t,kode_area varchar(255)","\t,catatan varchar(255)","\t,auto_succ tinyint","\t,par_balas varchar(255)","\t,apk_ikon varchar(255)","\t,struk_path varchar(255)","\t,struk_regex varchar(255)","\t,tgl_data datetime","\t,cutoff_awal varchar(5)","\t,cutoff_akhir varchar(5)","\t,cutoff_ket varchar(255)","\t,struk_auto_cetak tinyint",")","WITH ENCRYPTION","AS","BEGIN","\tINSERT INTO @table","\tSELECT","\t\tkode","\t\t,nama","\t\t,prefix_tujuan","\t\t,gangguan","\t\t,kosong","\t\t,regex_tujuan","\t\t,kode_hlr","\t\t,panjang_maks","\t\t,panjang_min","\t\t,prioritas","\t\t,format_sukses","\t\t,kode_level","\t\t,kode_area","\t\t,catatan","\t\t,auto_succ","\t\t,par_balas","\t\t,apk_ikon","\t\t,struk_path","\t\t,struk_regex","\t\t,tgl_data","\t\t,cutoff_awal","\t\t,cutoff_akhir","\t\t,cutoff_ket","\t\t,struk_auto_cetak","\tFROM OPENJSON(@json)","\tWITH (","\t\tkode varchar(10)","\t\t,nama varchar(30)","\t\t,prefix_tujuan varchar(4000)","\t\t,gangguan tinyint","\t\t,kosong tinyint","\t\t,regex_tujuan varchar(255)","\t\t,kode_hlr varchar(30)","\t\t,panjang_maks tinyint","\t\t,panjang_min tinyint","\t\t,prioritas tinyint","\t\t,format_sukses varchar(255)","\t\t,kode_level varchar(255)","\t\t,kode_area varchar(255)","\t\t,catatan varchar(255)","\t\t,auto_succ tinyint","\t\t,par_balas varchar(255)","\t\t,apk_ikon varchar(255)","\t\t,struk_path varchar(255)","\t\t,struk_regex varchar(255)","\t\t,tgl_data datetime","\t\t,cutoff_awal varchar(5)","\t\t,cutoff_akhir varchar(5)","\t\t,cutoff_ket varchar(255)","\t\t,struk_auto_cetak tinyint","\t)","\tRETURN ","END","GO","","CREATE OR ALTER FUNCTION dbo.fn_json_produk ","(","\t@json VARCHAR(MAX)",")","RETURNS ","@table TABLE (","\tkode varchar(10),","\tnama varchar(50),","\tharga_jual money,","\tharga_beli money,","\tstok int,","\taktif tinyint,","\tgangguan tinyint,","\tfisik tinyint,","\tkode_operator varchar(10),","\tprefix_tujuan varchar(255),","\tnominal smallint,","\tkosong tinyint,","\tkode_hlr varchar(30),","\ttanpa_kode tinyint,","\tharga_tetap tinyint,","\tkode_area varchar(255),","\tcatatan varchar(255),","\tsms_end_user tinyint,","\tpostpaid tinyint,","\trumus_harga tinyint,","\tqty varchar(100),","\tpoin smallint,","\tharga_awal money,","\ttgl_data datetime,","\tunit tinyint",")","WITH ENCRYPTION","AS","BEGIN","\tINSERT INTO @table","\tSELECT","\t\tkode","\t\t,nama","\t\t,harga_jual","\t\t,harga_beli","\t\t,stok","\t\t,aktif","\t\t,gangguan","\t\t,fisik","\t\t,kode_operator","\t\t,prefix_tujuan","\t\t,nominal","\t\t,kosong","\t\t,kode_hlr","\t\t,tanpa_kode","\t\t,harga_tetap","\t\t,kode_area","\t\t,catatan","\t\t,sms_end_user","\t\t,postpaid","\t\t,rumus_harga","\t\t,qty","\t\t,poin","\t\t,harga_awal","\t\t,tgl_data","\t\t,unit ","\tFROM OPENJSON(@json)","\tWITH (","\t\tkode varchar(10),","\t\tnama varchar(50),","\t\tharga_jual money,","\t\tharga_beli money,","\t\tstok int,","\t\taktif tinyint,","\t\tgangguan tinyint,","\t\tfisik tinyint,","\t\tkode_operator varchar(10),","\t\tprefix_tujuan varchar(255),","\t\tnominal smallint,","\t\tkosong tinyint,","\t\tkode_hlr varchar(30),","\t\ttanpa_kode tinyint,","\t\tharga_tetap tinyint,","\t\tkode_area varchar(255),","\t\tcatatan varchar(255),","\t\tsms_end_user tinyint,","\t\tpostpaid tinyint,","\t\trumus_harga tinyint,","\t\tqty varchar(100),","\t\tpoin smallint,","\t\tharga_awal money,","\t\ttgl_data datetime,","\t\tunit tinyint","\t)","\tRETURN ","END","GO","","USE otomax","GO","","-- usp","","CREATE OR ALTER PROCEDURE dbo.usp_put_operator","\t@json VARCHAR(MAX)","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","    MERGE operator AS TARGET ","    USING (SELECT * FROM dbo.fn_json_operator(@json)) AS SOURCE ","    ON SOURCE.kode = TARGET.kode ","    WHEN MATCHED AND (","\t\tISNULL(SOURCE.nama, '') <> ISNULL(TARGET.nama, '')","\t\tOR ISNULL(SOURCE.prefix_tujuan, '') <> ISNULL(TARGET.prefix_tujuan, '')","\t\tOR ISNULL(SOURCE.gangguan, '') <> ISNULL(TARGET.gangguan, '')","\t\tOR ISNULL(SOURCE.kosong, '') <> ISNULL(TARGET.kosong, '')","\t\tOR ISNULL(SOURCE.regex_tujuan, '') <> ISNULL(TARGET.regex_tujuan, '')","\t\tOR ISNULL(SOURCE.kode_hlr, '') <> ISNULL(TARGET.kode_hlr, '')","\t\tOR ISNULL(SOURCE.panjang_maks, '') <> ISNULL(TARGET.panjang_maks, '')","\t\tOR ISNULL(SOURCE.panjang_min, '') <> ISNULL(TARGET.panjang_min, '')","\t\tOR ISNULL(SOURCE.prioritas, '') <> ISNULL(TARGET.prioritas, '')","\t\tOR ISNULL(SOURCE.format_sukses, '') <> ISNULL(TARGET.format_sukses, '')","\t\tOR ISNULL(SOURCE.kode_level, '') <> ISNULL(TARGET.kode_level, '')","\t\tOR ISNULL(SOURCE.kode_area, '') <> ISNULL(TARGET.kode_area, '')","\t\tOR ISNULL(SOURCE.catatan, '') <> ISNULL(TARGET.catatan, '')","\t\tOR ISNULL(SOURCE.auto_succ, '') <> ISNULL(TARGET.auto_succ, '')","\t\tOR ISNULL(SOURCE.par_balas, '') <> ISNULL(TARGET.par_balas, '')","\t\tOR ISNULL(SOURCE.apk_ikon, '') <> ISNULL(TARGET.apk_ikon, '')","\t\tOR ISNULL(SOURCE.struk_path, '') <> ISNULL(TARGET.struk_path, '')","\t\tOR ISNULL(SOURCE.struk_regex, '') <> ISNULL(TARGET.struk_regex, '')","\t\tOR ISNULL(SOURCE.tgl_data, '') <> ISNULL(TARGET.tgl_data, '')","\t\tOR ISNULL(SOURCE.cutoff_awal, '') <> ISNULL(TARGET.cutoff_awal, '')","\t\tOR ISNULL(SOURCE.cutoff_akhir, '') <> ISNULL(TARGET.cutoff_akhir, '')","\t\tOR ISNULL(SOURCE.cutoff_ket, '') <> ISNULL(TARGET.cutoff_ket, '')","\t\tOR ISNULL(SOURCE.struk_auto_cetak, '') <> ISNULL(TARGET.struk_auto_cetak, '')","    ) THEN ","        UPDATE SET","\t\t\tnama = ISNULL(SOURCE.nama, TARGET.nama)","\t\t\t,prefix_tujuan = ISNULL(SOURCE.prefix_tujuan, TARGET.prefix_tujuan)","\t\t\t,gangguan = ISNULL(SOURCE.gangguan, TARGET.gangguan)","\t\t\t,kosong = ISNULL(SOURCE.kosong, TARGET.kosong)","\t\t\t,regex_tujuan = ISNULL(SOURCE.regex_tujuan, TARGET.regex_tujuan)","\t\t\t,kode_hlr = ISNULL(SOURCE.kode_hlr, TARGET.kode_hlr)","\t\t\t,panjang_maks = ISNULL(SOURCE.panjang_maks, TARGET.panjang_maks)","\t\t\t,panjang_min = ISNULL(SOURCE.panjang_min, TARGET.panjang_min)","\t\t\t,prioritas = ISNULL(SOURCE.prioritas, TARGET.prioritas)","\t\t\t,format_sukses = ISNULL(SOURCE.format_sukses, TARGET.format_sukses)","\t\t\t,kode_level = ISNULL(SOURCE.kode_level, TARGET.kode_level)","\t\t\t,kode_area = ISNULL(SOURCE.kode_area, TARGET.kode_area)","\t\t\t,catatan = ISNULL(SOURCE.catatan, TARGET.catatan)","\t\t\t,auto_succ = ISNULL(SOURCE.auto_succ, TARGET.auto_succ)","\t\t\t,par_balas = ISNULL(SOURCE.par_balas, TARGET.par_balas)","\t\t\t,apk_ikon = ISNULL(SOURCE.apk_ikon, TARGET.apk_ikon)","\t\t\t,struk_path = ISNULL(SOURCE.struk_path, TARGET.struk_path)","\t\t\t,struk_regex = ISNULL(SOURCE.struk_regex, TARGET.struk_regex)","\t\t\t,tgl_data = ISNULL(SOURCE.tgl_data, TARGET.tgl_data)","\t\t\t,cutoff_awal = ISNULL(SOURCE.cutoff_awal, TARGET.cutoff_awal)","\t\t\t,cutoff_akhir = ISNULL(SOURCE.cutoff_akhir, TARGET.cutoff_akhir)","\t\t\t,cutoff_ket = ISNULL(SOURCE.cutoff_ket, TARGET.cutoff_ket)","\t\t\t,struk_auto_cetak = ISNULL(SOURCE.struk_auto_cetak, TARGET.struk_auto_cetak)","    WHEN NOT MATCHED BY TARGET THEN","        INSERT (","\t\t\tkode","\t\t\t,nama","\t\t\t,prefix_tujuan","\t\t\t,gangguan","\t\t\t,kosong","\t\t\t,regex_tujuan","\t\t\t,kode_hlr","\t\t\t,panjang_maks","\t\t\t,panjang_min","\t\t\t,prioritas","\t\t\t,format_sukses","\t\t\t,kode_level","\t\t\t,kode_area","\t\t\t,catatan","\t\t\t,auto_succ","\t\t\t,par_balas","\t\t\t,apk_ikon","\t\t\t,struk_path","\t\t\t,struk_regex","\t\t\t,tgl_data","\t\t\t,cutoff_awal","\t\t\t,cutoff_akhir","\t\t\t,cutoff_ket","\t\t\t,struk_auto_cetak","        )","        VALUES (","\t\t\tSOURCE.kode","\t\t\t,SOURCE.nama","\t\t\t,SOURCE.prefix_tujuan","\t\t\t,SOURCE.gangguan","\t\t\t,SOURCE.kosong","\t\t\t,SOURCE.regex_tujuan","\t\t\t,SOURCE.kode_hlr","\t\t\t,SOURCE.panjang_maks","\t\t\t,SOURCE.panjang_min","\t\t\t,SOURCE.prioritas","\t\t\t,SOURCE.format_sukses","\t\t\t,SOURCE.kode_level","\t\t\t,SOURCE.kode_area","\t\t\t,SOURCE.catatan","\t\t\t,SOURCE.auto_succ","\t\t\t,SOURCE.par_balas","\t\t\t,SOURCE.apk_ikon","\t\t\t,SOURCE.struk_path","\t\t\t,SOURCE.struk_regex","\t\t\t,SOURCE.tgl_data","\t\t\t,SOURCE.cutoff_awal","\t\t\t,SOURCE.cutoff_akhir","\t\t\t,SOURCE.cutoff_ket","\t\t\t,SOURCE.struk_auto_cetak","        )","    -- WHEN NOT MATCHED BY SOURCE THEN ","    --     DELETE","    -- OUTPUT $action, INSERTED.*, DELETED.*","    ;","END","GO","","CREATE OR ALTER PROCEDURE dbo.usp_put_produk","\t@json VARCHAR(MAX)","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","    MERGE produk AS TARGET ","    USING (SELECT * FROM dbo.fn_json_produk(@json)) AS SOURCE ","    ON SOURCE.kode = TARGET.kode ","    WHEN MATCHED AND (","\t\tISNULL(SOURCE.nama, '') <> ISNULL(TARGET.nama, '')","\t\tOR ISNULL(SOURCE.harga_jual, '') <> ISNULL(TARGET.harga_jual, '')","\t\tOR ISNULL(SOURCE.harga_beli, '') <> ISNULL(TARGET.harga_beli, '')","\t\tOR ISNULL(SOURCE.stok, '') <> ISNULL(TARGET.stok, '')","\t\tOR ISNULL(SOURCE.aktif, '') <> ISNULL(TARGET.aktif, '')","\t\tOR ISNULL(SOURCE.gangguan, '') <> ISNULL(TARGET.gangguan, '')","\t\tOR ISNULL(SOURCE.fisik, '') <> ISNULL(TARGET.fisik, '')","\t\tOR ISNULL(SOURCE.kode_operator, '') <> ISNULL(TARGET.kode_operator, '')","\t\tOR ISNULL(SOURCE.prefix_tujuan, '') <> ISNULL(TARGET.prefix_tujuan, '')","\t\tOR ISNULL(SOURCE.nominal, '') <> ISNULL(TARGET.nominal, '')","\t\tOR ISNULL(SOURCE.kosong, '') <> ISNULL(TARGET.kosong, '')","\t\tOR ISNULL(SOURCE.kode_hlr, '') <> ISNULL(TARGET.kode_hlr, '')","\t\tOR ISNULL(SOURCE.tanpa_kode, '') <> ISNULL(TARGET.tanpa_kode, '')","\t\tOR ISNULL(SOURCE.harga_tetap, '') <> ISNULL(TARGET.harga_tetap, '')","\t\tOR ISNULL(SOURCE.kode_area, '') <> ISNULL(TARGET.kode_area, '')","\t\tOR ISNULL(SOURCE.catatan, '') <> ISNULL(TARGET.catatan, '')","\t\tOR ISNULL(SOURCE.sms_end_user, '') <> ISNULL(TARGET.sms_end_user, '')","\t\tOR ISNULL(SOURCE.postpaid, '') <> ISNULL(TARGET.postpaid, '')","\t\tOR ISNULL(SOURCE.rumus_harga, '') <> ISNULL(TARGET.rumus_harga, '')","\t\tOR ISNULL(SOURCE.qty, '') <> ISNULL(TARGET.qty, '')","\t\tOR ISNULL(SOURCE.poin, '') <> ISNULL(TARGET.poin, '')","\t\tOR ISNULL(SOURCE.harga_awal, '') <> ISNULL(TARGET.harga_awal, '')","\t\tOR ISNULL(SOURCE.tgl_data, '') <> ISNULL(TARGET.tgl_data, '')","\t\tOR ISNULL(SOURCE.unit, '') <> ISNULL(TARGET.unit, '') ","    ) THEN ","        UPDATE SET","\t\t\tnama = ISNULL(SOURCE.nama, TARGET.nama)","\t\t\t,harga_jual = ISNULL(SOURCE.harga_jual, TARGET.harga_jual)","\t\t\t,harga_beli = ISNULL(SOURCE.harga_beli, TARGET.harga_beli)","\t\t\t,stok = ISNULL(SOURCE.stok, TARGET.stok)","\t\t\t,aktif = ISNULL(SOURCE.aktif, TARGET.aktif)","\t\t\t,gangguan = ISNULL(SOURCE.gangguan, TARGET.gangguan)","\t\t\t,fisik = ISNULL(SOURCE.fisik, TARGET.fisik)","\t\t\t,kode_operator = ISNULL(SOURCE.kode_operator, TARGET.kode_operator)","\t\t\t,prefix_tujuan = ISNULL(SOURCE.prefix_tujuan, TARGET.prefix_tujuan)","\t\t\t,nominal = ISNULL(SOURCE.nominal, TARGET.nominal)","\t\t\t,kosong = ISNULL(SOURCE.kosong, TARGET.kosong)","\t\t\t,kode_hlr = ISNULL(SOURCE.kode_hlr, TARGET.kode_hlr)","\t\t\t,tanpa_kode = ISNULL(SOURCE.tanpa_kode, TARGET.tanpa_kode)","\t\t\t,harga_tetap = ISNULL(SOURCE.harga_tetap, TARGET.harga_tetap)","\t\t\t,kode_area = ISNULL(SOURCE.kode_area, TARGET.kode_area)","\t\t\t,catatan = ISNULL(SOURCE.catatan, TARGET.catatan)","\t\t\t,sms_end_user = ISNULL(SOURCE.sms_end_user, TARGET.sms_end_user)","\t\t\t,postpaid = ISNULL(SOURCE.postpaid, TARGET.postpaid)","\t\t\t,rumus_harga = ISNULL(SOURCE.rumus_harga, TARGET.rumus_harga)","\t\t\t,qty = ISNULL(SOURCE.qty, TARGET.qty)","\t\t\t,poin = ISNULL(SOURCE.poin, TARGET.poin)","\t\t\t,harga_awal = ISNULL(SOURCE.harga_awal, TARGET.harga_awal)","\t\t\t,tgl_data = ISNULL(SOURCE.tgl_data, TARGET.tgl_data)","\t\t\t,unit = ISNULL(SOURCE.unit, TARGET.unit)","    WHEN NOT MATCHED BY TARGET THEN","        INSERT (","\t\t\tkode","\t\t\t,nama","\t\t\t,harga_jual","\t\t\t,harga_beli","\t\t\t,stok","\t\t\t,aktif","\t\t\t,gangguan","\t\t\t,fisik","\t\t\t,kode_operator","\t\t\t,prefix_tujuan","\t\t\t,nominal","\t\t\t,kosong","\t\t\t,kode_hlr","\t\t\t,tanpa_kode","\t\t\t,harga_tetap","\t\t\t,kode_area","\t\t\t,catatan","\t\t\t,sms_end_user","\t\t\t,postpaid","\t\t\t,rumus_harga","\t\t\t,qty","\t\t\t,poin","\t\t\t,harga_awal","\t\t\t,tgl_data","\t\t\t,unit ","        )","        VALUES (","\t\t\tSOURCE.kode","\t\t\t,SOURCE.nama","\t\t\t,SOURCE.harga_jual","\t\t\t,SOURCE.harga_beli","\t\t\t,SOURCE.stok","\t\t\t,SOURCE.aktif","\t\t\t,SOURCE.gangguan","\t\t\t,SOURCE.fisik","\t\t\t,SOURCE.kode_operator","\t\t\t,SOURCE.prefix_tujuan","\t\t\t,SOURCE.nominal","\t\t\t,SOURCE.kosong","\t\t\t,SOURCE.kode_hlr","\t\t\t,SOURCE.tanpa_kode","\t\t\t,SOURCE.harga_tetap","\t\t\t,SOURCE.kode_area","\t\t\t,SOURCE.catatan","\t\t\t,SOURCE.sms_end_user","\t\t\t,SOURCE.postpaid","\t\t\t,SOURCE.rumus_harga","\t\t\t,SOURCE.qty","\t\t\t,SOURCE.poin","\t\t\t,SOURCE.harga_awal","\t\t\t,SOURCE.tgl_data","\t\t\t,SOURCE.unit ","        )","    -- WHEN NOT MATCHED BY SOURCE THEN ","    --     DELETE","    -- OUTPUT $action, INSERTED.*, DELETED.*","    ;","END","GO","","USE otomax","GO","","","CREATE OR ALTER TRIGGER tr_produk ","   ON produk","   WITH ENCRYPTION","   AFTER INSERT,DELETE,UPDATE","AS ","BEGIN","\tSET NOCOUNT ON;","    DECLARE ","    @action VARCHAR(6) = (CASE","        WHEN EXISTS(SELECT 1 FROM INSERTED) AND EXISTS(SELECT 1 FROM DELETED) THEN 'UPDATE'","        WHEN EXISTS(SELECT 1 FROM INSERTED) THEN 'INSERT'","        WHEN EXISTS(SELECT 1 FROM DELETED) THEN 'DELETE'","    END)","    ,@message VARCHAR(MAX)","","    IF (@action = 'UPDATE' OR @action = 'INSERT' OR @action = 'DELETE')","    BEGIN","        SET @message = (SELECT 'produk' AS event_name, * FROM INSERTED FOR JSON PATH, INCLUDE_NULL_VALUES)","        EXEC usp_service_broker_send @message","    END","    ELSE IF (@action = 'DELETE')","    BEGIN","        SET @message = (SELECT 'produk' AS event_name, * FROM DELETED FOR JSON PATH, INCLUDE_NULL_VALUES)","        EXEC usp_service_broker_send @message","    END","END","GO","","CREATE OR ALTER TRIGGER tr_operator ","   ON operator","   WITH ENCRYPTION","   AFTER INSERT,DELETE,UPDATE","AS ","BEGIN","\tSET NOCOUNT ON;","    DECLARE ","    @action VARCHAR(6) = (CASE","        WHEN EXISTS(SELECT 1 FROM INSERTED) AND EXISTS(SELECT 1 FROM DELETED) THEN 'UPDATE'","        WHEN EXISTS(SELECT 1 FROM INSERTED) THEN 'INSERT'","        WHEN EXISTS(SELECT 1 FROM DELETED) THEN 'DELETE'","    END)","    ,@message VARCHAR(MAX)","","    IF (@action = 'UPDATE' OR @action = 'INSERT' OR @action = 'DELETE')","    BEGIN","        SET @message = (SELECT 'operator' AS event_name, * FROM INSERTED FOR JSON PATH, INCLUDE_NULL_VALUES)","        EXEC usp_service_broker_send @message","    END","    ELSE IF (@action = 'DELETE')","    BEGIN","        SET @message = (SELECT 'operator' AS event_name, * FROM DELETED FOR JSON PATH, INCLUDE_NULL_VALUES)","        EXEC usp_service_broker_send @message","    END","END","GO","","-- USE otomax","-- GO","","-- -- test","","","-- DECLARE @json VARCHAR(MAX)","-- SET @json = '[{\"kode\":\"NDIING\",\"nama\":\"AXIS DATA\",\"prefix_tujuan\":\"0838,0831,0817,0818,0819,0859,0878,0877,08188,0832\",\"gangguan\":0,\"kosong\":0,\"regex_tujuan\":null,\"kode_hlr\":null,\"panjang_maks\":13,\"panjang_min\":10,\"prioritas\":0,\"format_sukses\":null,\"kode_level\":null,\"kode_area\":null,\"catatan\":null,\"auto_succ\":null,\"par_balas\":null,\"apk_ikon\":null,\"struk_path\":null,\"struk_regex\":null,\"tgl_data\":\"2019-11-18T19:53:59.567\",\"cutoff_awal\":null,\"cutoff_akhir\":null,\"cutoff_ket\":null,\"struk_auto_cetak\":null}]' ","","-- EXEC dbo.usp_put_operator @json","","-- SELECT * FROM operator","","-- DECLARE @json VARCHAR(MAX)","-- -- SET @json = '[{\"kode\":\"AIGO1\",\"nama\":\"Vou Aigo 1GB Nas 30Hr\",\"harga_jual\":12950.0000,\"harga_beli\":0.0000,\"stok\":0,\"aktif\":1,\"gangguan\":0,\"fisik\":0,\"kode_operator\":\"AXD\",\"prefix_tujuan\":null,\"nominal\":1,\"kosong\":0,\"kode_hlr\":null,\"tanpa_kode\":0,\"harga_tetap\":0,\"kode_area\":null,\"catatan\":null,\"sms_end_user\":0,\"postpaid\":0,\"rumus_harga\":null,\"qty\":null,\"poin\":null,\"harga_awal\":null,\"tgl_data\":\"2023-04-30T06:12:52.220\",\"unit\":null}]' ","-- SET @json = '[{\"kode\":\"NDIING\",\"kode_operator\":\"NDIING\",\"harga_jual\":13000.0000,\"harga_beli\":0.0000}]' ","","-- EXEC dbo.usp_put_produk @json","","-- SELECT * FROM produk","","USE otomax","GO","","CREATE OR ALTER PROCEDURE usp_post_data_bank","\t@jumlah int ","\t,@bank varchar(255)","\t,@no_rekening varchar(50)","\t,@tgl_bank varchar(20)","\t,@tipe char(1)","\t,@saldo money","\t,@keterangan varchar(255)","WITH ENCRYPTION","AS","BEGIN","\tSET NOCOUNT ON;","","    BEGIN TRY","        BEGIN TRAN","","        DECLARE","            @status char(1) = 'O'","            ,@kode_inbox int","            ,@kode_data_bank int","            ,@kode_reseller varchar(20)","            ,@kode_tiket int","            ,@terklaim tinyint = 0","            ,@catatan varchar(255)","            ,@kode_rekening int","            ,@penerima varchar(255)","            ,@pengirim varchar(255)","            ,@tipe_pengirim char(1)","            ,@saldolama money","            ,@systime datetime = GETDATE()","            ,@time datetime","","        SET @time = @systime","","        SELECT ","            @kode_tiket = kode ","            ,@kode_inbox = kode_inbox ","            ,@kode_reseller = kode_reseller ","        FROM tiket_deposit ","        WHERE jumlah = @jumlah ","        AND status = 'O'","        -- AND @tipe = 'K'","        -- OR (status = 'S' AND @tipe = 'D')","","        IF ISNULL(@kode_tiket, '') <> ''","        BEGIN","            SET @status = 'S'","            SET @catatan = 'Tiket '+@kode_reseller+''","            SET @terklaim = 1","        END","","        SELECT ","            @kode_rekening = kode ","        FROM rekening_bank ","        WHERE no_rekening = @no_rekening","","        IF ISNULL(@kode_rekening,'') = ''","        BEGIN","            DECLARE @rekening_bank TABLE (kode int) ","","            INSERT INTO rekening_bank (bank, no_rekening)","            OUTPUT INSERTED.kode INTO @rekening_bank","            VALUES (@bank, @no_rekening)","","            SELECT ","                @kode_rekening = kode ","            FROM @rekening_bank","        END","","        DECLARE @data_bank TABLE (kode int)","","        INSERT INTO data_bank (bank, tgl_proses, tgl_bank, jumlah, tipe, saldo, keterangan, kode_tiket, terklaim, kode_rekening)","        OUTPUT INSERTED.kode INTO @data_bank","        VALUES (@bank, @systime, @tgl_bank, @jumlah, @tipe, @saldo, @keterangan, @kode_tiket, @terklaim, @kode_rekening)","","        SELECT @kode_data_bank = kode FROM @data_bank","","        SET @saldo = NULL","","        IF ISNULL(@kode_tiket,'') <> ''","        BEGIN","            UPDATE tiket_deposit SET","                status = @status","                ,tgl_status = @systime","                ,kode_data_bank = @kode_data_bank","            WHERE kode = @kode_tiket","","            SELECT @saldolama = saldo FROM reseller WHERE kode = @kode_reseller","","            -- IF @tipe = 'K'","            -- BEGIN","                SET @saldo = @saldolama + @jumlah","            -- END","            -- ELSE IF @tipe = 'D'","            -- BEGIN","            --     SET @saldo = @saldolama - @jumlah","            -- END","","            UPDATE reseller SET saldo = @saldo WHERE kode = @kode_reseller","","            SET @keterangan = 'Tiket deposit '+@bank+' '+@no_rekening+''","","            INSERT INTO mutasi (kode_reseller, tanggal, jumlah, keterangan, jenis, saldo_akhir)","            VALUES (@kode_reseller, @systime, @jumlah, @keterangan, 'B', @saldo)","","            SELECT","                @penerima = penerima","                ,@pengirim = pengirim","                ,@tipe_pengirim = tipe_pengirim","            FROM inbox","            WHERE kode = @kode_inbox","        END","","        SELECT","            @jumlah AS jumlah","            ,@bank AS bank","            ,@no_rekening AS no_rekening","            ,@tgl_bank AS tgl_bank","            ,@tipe AS tipe","            ,@saldo AS saldo","            ,@keterangan AS keterangan","            ,@status AS status","            ,@kode_inbox AS kode_inbox","            ,@kode_data_bank AS kode_data_bank","            ,@kode_reseller AS kode_reseller","            ,@kode_tiket AS kode_tiket","            ,@terklaim AS terklaim","            ,@catatan AS catatan","            ,@kode_rekening AS kode_rekening","            ,@penerima AS penerima","            ,@pengirim AS pengirim","            ,@tipe_pengirim AS tipe_pengirim","            ,@saldolama AS saldolama","            ,@systime AS systime","            ,@time AS time","","        COMMIT TRAN","    END TRY","    BEGIN CATCH","        ROLLBACK TRAN","        SELECT","            ERROR_MESSAGE(),","            ERROR_SEVERITY(),","            ERROR_STATE()","    END CATCH","END","GO",""]
